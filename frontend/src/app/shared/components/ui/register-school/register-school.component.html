<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 flex items-center justify-center p-4">
  <div class="w-full max-w-3xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <img src="images/ED-logo.png" alt="Logo" class="mx-auto h-12 w-auto mb-4" />
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Create School Account</h1>
      <p class="text-gray-600 dark:text-gray-400 mb-6">Complete in 3 steps</p>

      <!-- Step indicator -->
      <div class="flex justify-center space-x-3 mb-10">
        @for (s of [1,2,3]; track s) {
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold transition-all"
                 [class.bg-blue-600]="step() >= s"
                 [class.text-white]="step() >= s"
                 [class.bg-gray-200]="step() < s"
                 [class.dark:bg-gray-700]="step() < s"
                 [class.text-gray-500]="step() < s"
                 [class.dark:text-gray-400]="step() < s">
              {{ s }}
            </div>
            @if (s < 3) {
              <div class="w-12 h-1 mx-2"
                   [class.bg-blue-600]="step() > s"
                   [class.bg-gray-200]="step() <= s"
                   [class.dark:bg-gray-700]="step() <= s"></div>
            }
          </div>
        }
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10">

      <!-- STEP 1 -->
      @if (step() === 1) {
        <form [formGroup]="schoolForm" (ngSubmit)="nextStep()" class="space-y-8">

          <!-- Basic info -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <app-label for="schoolName">School Name <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed id="schoolName" formControlName="schoolName" placeholder="Elite Public School" />
            </div>
            <div>
              <app-label for="adminName">Admin Name <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed id="adminName" formControlName="adminName" placeholder="John Doe" />
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-6">
            <div>
              <app-label>Username <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="username" placeholder="admin123" />
            </div>
            <div>
              <app-label>Email <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed type="email" formControlName="email" placeholder="admin@school.com" />
            </div>
            <div>
              <app-label>Mobile <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="mobileNo" placeholder="+919876543210" />
            </div>
          </div>

          <!-- Communication setup -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <app-label>SMS Sender Name (6-11 chars) <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="smsSenderName" maxlength="11" placeholder="EDGLOBE" />
            </div>
            <div>
              <app-label>School Email (From) <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed type="email" formControlName="emailFrom" placeholder="principal@school.com" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <app-label>From Name (optional)</app-label>
              <app-input-field-fixed formControlName="emailName" placeholder="Elite Public School" />
            </div>
            <div>
              <app-label>Email App Password <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed type="password" formControlName="emailPass" placeholder="xxxx xxxx xxxx xxxx" />
              <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-xs text-blue-600 hover:underline block mt-1">
                Generate App Password
              </a>
            </div>
          </div>

          <!-- Academic Year -->
          <div class="bg-indigo-50 dark:bg-indigo-950/40 p-6 rounded-xl border border-indigo-100 dark:border-indigo-800">
            <h3 class="text-lg font-semibold mb-4 text-indigo-800 dark:text-indigo-200">
              Academic Year <span class="text-red-500">*</span>
            </h3>
            
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <app-label>Select Academic Year</app-label>
                <app-select formControlName="academicYearName" [options]="[
                  {value: '2025-2026', label: '2025-2026'},
                  {value: '2026-2027', label: '2026-2027'},
                  {value: '2027-2028', label: '2027-2028'},
                  {value: '2028-2029', label: '2028-2029'},
                  {value: '2029-2030', label: '2029-2030'}
                ]" placeholder="Choose academic year" />
              </div>

              <!-- Optional: still show start & end dates (read-only or hidden) -->
              <!-- If you want to show them auto-filled based on selection, we can add logic later -->
            </div>
          </div>

          <!-- Subscription -->
          <div class="bg-amber-50 dark:bg-amber-950/40 p-6 rounded-xl border border-amber-100 dark:border-amber-800">
            <h3 class="text-lg font-semibold mb-4 text-amber-800 dark:text-amber-200">
              Assign Subscription (optional – decided by superadmin)
            </h3>
            
            <label class="flex items-center mb-4 cursor-pointer">
              <input type="checkbox" formControlName="assignSubscriptionNow" class="h-5 w-5 text-amber-600 rounded" />
              <span class="ml-3 font-medium text-gray-800 dark:text-gray-200">
                Assign subscription / trial now
              </span>
            </label>

            @if (schoolForm.get('assignSubscriptionNow')?.value) {
              <div class="grid md:grid-cols-2 gap-6 pl-8">
                <div>
                  <app-label>Plan Type</app-label>
                  <app-select formControlName="subscriptionType" [options]="[
                    {value: 'trial', label: 'Trial'},
                    {value: 'basic', label: 'Basic'},
                    {value: 'premium', label: 'Premium'}
                  ]" />
                </div>
                <div>
                  <app-label>Duration</app-label>
                  <app-select formControlName="subscriptionDurationDays" [options]="[
                    {value: '14',  label: '14 days (quick trial)'},
                    {value: '30',  label: '30 days (1 month)'},
                    {value: '60',  label: '60 days (2 months)'},
                    {value: '90',  label: '90 days (3 months)'},
                    {value: '180', label: '180 days (6 months)'},
                    {value: '365', label: '365 days (1 full year)'}
                  ]" />
                </div>
              </div>
            }
          </div>

          <!-- Fast Track – only superadmin -->
          @if (isSuperadmin()) {
            <div class="bg-blue-50 dark:bg-blue-950/40 p-6 rounded-xl border border-blue-100 dark:border-blue-800">
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" formControlName="fastTrack" class="h-5 w-5 text-blue-600 rounded" />
                <span class="ml-3 font-medium text-blue-800 dark:text-blue-200">Superadmin Fast-Track: Skip OTP & instant access</span>
              </label>
              <p class="text-sm text-blue-700 dark:text-blue-300 mt-2 ml-8">
                Only use for trusted schools – no mobile verification required
              </p>
            </div>
          }

          <!-- Buttons -->
          <div class="flex gap-4 pt-8">
            <button type="button" (click)="prevStep()" class="flex-1 py-3.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition">
              Back
            </button>
            <button type="submit" [disabled]="schoolForm.invalid || isSendingOtp()"
                    class="flex-1 py-3.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition disabled:opacity-60">
              {{ isSendingOtp() ? 'Sending OTP...' : 'Next – Verify Mobile' }}
            </button>
          </div>
        </form>
      }

      <!-- STEP 2: OTP -->
      @if (step() === 2) {
        <form [formGroup]="otpForm" (ngSubmit)="nextStep()" class="space-y-8 text-center">
          <div class="mx-auto w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>

          <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Verify Mobile Number</h2>
          <p class="text-gray-600 dark:text-gray-300">
            Enter 6-digit OTP sent to <strong>{{ formData().mobileNo }}</strong>
          </p>

          <app-input-field-fixed
            id="otp"
            type="text"
            formControlName="otp"
            placeholder="000000"
            className="text-center text-3xl font-mono tracking-widest"
            maxlength="6" />

          <p class="text-sm text-gray-500 mt-4">
            Didn't receive? <button type="button" (click)="sendOtp()" [disabled]="isSendingOtp()" class="text-blue-600 underline ml-1">Resend OTP</button>
          </p>

          <div class="flex gap-4 pt-6">
            <button type="button" (click)="prevStep()" class="flex-1 py-3.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium">
              Back
            </button>
            <button type="submit" [disabled]="otpForm.invalid || isVerifyingOtp()"
                    class="flex-1 py-3.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-60">
              {{ isVerifyingOtp() ? 'Verifying...' : 'Verify & Continue' }}
            </button>
          </div>
        </form>
      }

      <!-- STEP 3: Address -->
      @if (step() === 3) {
        <form [formGroup]="addressForm" (ngSubmit)="nextStep()" class="space-y-8">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">School Address</h2>
            <p class="text-gray-600 dark:text-gray-300">Click on map to set exact location</p>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <app-label>Street <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="street" placeholder="123 Main Road" />
            </div>
            <div>
              <app-label>Postal Code <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="postalCode" placeholder="834001" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <app-label>City <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="city" placeholder="Ranchi" />
            </div>
            <div>
              <app-label>State <span class="text-red-500">*</span></app-label>
              <app-input-field-fixed formControlName="state" placeholder="Jharkhand" />
            </div>
          </div>

          <div>
            <app-label>Country <span class="text-red-500">*</span></app-label>
            <app-input-field-fixed formControlName="country" placeholder="India" />
          </div>

          <!-- Map -->
          <div class="mt-6">
            <app-label>School Location on Map <span class="text-red-500">*</span></app-label>
            <div class="relative mt-2 rounded-xl overflow-hidden border border-gray-300 dark:border-gray-600 shadow">
              <div class="absolute top-3 right-3 z-10 bg-white dark:bg-gray-800 px-3 py-1 rounded text-xs shadow-md">
                Click to place pin
              </div>
              <google-map height="320px" width="100%" [center]="center" [zoom]="zoom" (mapClick)="onMapClick($event)">
                @if (markerPosition) {
                  <map-marker [position]="markerPosition" [title]="'School Location'"></map-marker>
                }
              </google-map>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">Click anywhere on the map to set coordinates</p>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <app-label>Latitude</app-label>
              <app-input-field-fixed type="number" formControlName="latitude" readonly className="bg-gray-100 dark:bg-gray-700" />
            </div>
            <div>
              <app-label>Longitude</app-label>
              <app-input-field-fixed type="number" formControlName="longitude" readonly className="bg-gray-100 dark:bg-gray-700" />
            </div>
          </div>

          @if (a['latitude'].invalid || a['longitude'].invalid) {
            <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 p-4 rounded-lg text-center">
              <p class="text-red-600 dark:text-red-400 font-medium">Location is required – please click on the map</p>
            </div>
          }

          <div class="flex gap-4 pt-8">
            <button type="button" (click)="prevStep()" class="flex-1 py-3.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium">
              Back
            </button>
            <button type="submit" [disabled]="addressForm.invalid || isSubmitting()"
                    class="flex-1 py-3.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-60">
              {{ isSubmitting() ? 'Creating School...' : 'Create School Account' }}
            </button>
          </div>
        </form>
      }
    </div>

    <div class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
      © 2025–2026 School Management System
    </div>
  </div>
</div>